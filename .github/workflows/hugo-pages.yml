name: ðŸ“– Build Hugo Site

on:
  workflow_call:
    inputs:
      GH_BRANCH:
        type: string
        required: true

jobs:
  build:
    runs-on: ubuntu-latest

    # Request only what you need here. The caller can elevate if needed.
    permissions:
      contents: read

    steps:
      # IMPORTANT: don't pass a custom token hereâ€”use the caller repo's GITHUB_TOKEN
      - name: Checkout caller repository
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Modify ace-documentation shortcode template to not require a page title
        run: sed -i 's/\.Title/\.File\.BaseFileName | humanize | title/' "${GITHUB_WORKSPACE}/themes/ace-documentation/layouts/shortcodes/childpages.html"

      - name: Modify ace-documentation left navbar template to not require a page title
        run: sed -i 's/\.LinkTitle/\.File\.BaseFileName | humanize | title/' "${GITHUB_WORKSPACE}/themes/ace-documentation/layouts/partials/menu.html"

      - name: Ensure markup directory exists
        run: mkdir -p "${GITHUB_WORKSPACE}/themes/ace-documentation/layouts/_default/_markup"

      - name: Create a markdown link render hook
        run: |
          cat << 'EOF' > "${GITHUB_WORKSPACE}/themes/ace-documentation/layouts/_default/_markup/render-link.html"
          {{- $link := .Destination }}
          {{- $url := urls.Parse $link }}
          {{- $isRemote := $url.IsAbs }}
          {{- if and (not $isRemote) (strings.HasSuffix $url.Path ".md") }}
            {{- $link = relref .Page $link }}
          {{- end -}}
          <a href="{{ $link | safeURL }}"{{ with .Title}} title="{{ . }}"{{ end }}{{ if $isRemote }} target="_blank"{{ end }}>{{ .Text | safeHTML }}</a>
          EOF

      - name: Create a mermaid render hook
        run: |
          cat << 'EOF' > "${GITHUB_WORKSPACE}/themes/ace-documentation/layouts/_default/_markup/render-codeblock-mermaid.html"
          <div class="mermaid">
            {{- .Inner | safeHTML }}
          </div>
          {{ .Page.Store.Set "hasMermaid" true }}
          EOF

      - name: Store mermaid config in temp file
        run: |
          cat << 'EOF' > /tmp/mermaid.snippet
          {{ if .Page.Store.Get "hasMermaid" }}
            <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
            <script>
              mermaid.initialize({ startOnLoad: true });
            </script>
          {{ end }}
          EOF

      - name: Insert mermaid snippet into docs theme
        run: sed -i '/{{ .Content }}/r /tmp/mermaid.snippet' "${GITHUB_WORKSPACE}/themes/ace-documentation/layouts/_default/single.html" || true

      - name: Create _index.md (Design)
        run: |
          mkdir -p design
          cat << 'EOF' > design/_index.md
          ---
          title: Design Documents
          ---
          {{< childpages >}}
          EOF

      - name: Create _index.md (Work Instructions)
        run: |
          mkdir -p workInstructions
          cat << 'EOF' > workInstructions/_index.md
          ---
          title: Work Instructions
          ---
          {{< childpages >}}
          EOF

      - name: Append the branch/version name to index.md
        run: sed -i "s/VERSION/${{ inputs.GH_BRANCH }}/" main/_index.md || true

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: true

      - name: Build
        run: hugo --minify

      # Upload the built site as an artifact, so the caller can decide how/where to deploy
      - name: Upload built site as artifact
        uses: actions/upload-artifact@v4
        with:
          name: hugo-site
          path: public
